@model IEnumerable<LibraryPro.Web.Models.Entities.Member>

@{
    ViewData["Title"] = "Loan Operations";
}

<div class="container py-5 animate-fade-in">
    @* --- Header Section --- *@
    <div class="row align-items-end mb-4">
        <div class="col-lg-6">
            <h2 class="fw-bold text-dark mb-1"><i class="bi bi-arrow-left-right text-primary me-2"></i>Loan Operations</h2>
            <p class="text-muted mb-0">Manage circulation, track overdues, and handle returns.</p>
        </div>
        <div class="col-lg-6 text-lg-end mt-3">
            <div class="d-inline-flex gap-2">
                <div class="input-group shadow-sm" style="width: 300px;">
                    <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                    <input type="text" id="loanSearch" class="form-control border-start-0" placeholder="Search member name...">
                </div>
                <a asp-action="Issue" class="btn btn-primary fw-bold px-4 shadow-sm rounded-pill">
                    <i class="bi bi-plus-lg me-2"></i>Issue Book
                </a>
            </div>
        </div>
    </div>

    @* --- Stats Cards Section --- *@
    <div class="row g-3 mb-4">
        @{
            // Flatten all loans from all members to calculate library-wide totals
            var allLoans = Model.SelectMany(m => m.Loans).ToList();

            var activeCount = allLoans.Count(l => !l.IsReturned);
            var overdueCount = allLoans.Count(l => !l.IsReturned && l.DueDate < DateTime.Now);
            var totalReturned = allLoans.Count(l => l.IsReturned);
            var returnRate = allLoans.Any() ? (totalReturned * 100 / allLoans.Count()) : 0;
            var totalFine = allLoans.Where(l => !l.IsReturned).Sum(l => l.CalculateLateFee);
        }
        <div class="col-md-3">
            <div class="card border-0 shadow-sm p-3">
                <div class="d-flex align-items-center">
                    <div class="stats-icon bg-primary-soft text-primary me-3"><i class="bi bi-journal-bookmark"></i></div>
                    <div><h4 class="mb-0 fw-bold">@activeCount</h4><small class="text-muted">Currently Out</small></div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm p-3">
                <div class="d-flex align-items-center">
                    <div class="stats-icon bg-danger-soft text-danger me-3"><i class="bi bi-exclamation-octagon"></i></div>
                    <div><h4 class="mb-0 fw-bold">@overdueCount</h4><small class="text-muted">Overdue Items</small></div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm p-3">
                <div class="d-flex align-items-center">
                    <div class="stats-icon bg-success-soft text-success me-3"><i class="bi bi-graph-up-arrow"></i></div>
                    <div><h4 class="mb-0 fw-bold">@returnRate%</h4><small class="text-muted">Return Rate</small></div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm p-3">
                <div class="d-flex align-items-center">
                    <div class="stats-icon bg-warning-soft text-warning me-3"><i class="bi bi-currency-rupee"></i></div>
                    <div>
                        <h4 class="mb-0 fw-bold">₹@totalFine.ToString("N0")</h4>
                        <small class="text-muted">Uncollected Fines</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @* --- Main Table --- *@
    <div class="card shadow-sm border-0 overflow-hidden">
        <div class="table-responsive">
            <table class="table align-middle mb-0" id="loansTable">
                <thead class="bg-dark text-white">
                    <tr class="small">
                        <th class="ps-4 py-3">Member Name</th>
                        <th>Contact Email</th>
                        <th>Phone</th>
                        <th class="text-center">Active Loans</th>
                        <th class="text-center">Status</th>
                        <th class="text-end pe-4">Details</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var m in Model)
                    {
                        var collapseId = "memberLoans" + m.Id;
                        var memberActiveLoans = m.Loans.Where(l => !l.IsReturned).ToList();
                        var isOverdue = memberActiveLoans.Any(l => l.DueDate < DateTime.Now);

                        <tr class="member-row" data-bs-toggle="collapse" data-bs-target="#@collapseId" style="cursor: pointer;">
                            <td class="ps-4">
                                <div class="d-flex align-items-center">
                                    <div class="avatar-circle me-3">@m.Name.Substring(0, 1).ToUpper()</div>
                                    <div>
                                        <span class="fw-bold d-block text-dark">@m.Name</span>
                                        <small class="text-muted">ID: #@m.Id.ToString("D4")</small>
                                    </div>
                                </div>
                            </td>
                            <td>@m.Email</td>
                            <td>@m.PhoneNumber</td>
                            <td class="text-center">
                                <span class="badge bg-light text-dark border rounded-pill px-3">
                                    @memberActiveLoans.Count Books
                                </span>
                            </td>
                            <td class="text-center">
                                @if (isOverdue)
                                {
                                    <span class="badge bg-danger-soft text-danger rounded-pill">Overdue Items</span>
                                }
                                else if (memberActiveLoans.Any())
                                {
                                    <span class="badge bg-primary-soft text-primary rounded-pill">Active</span>
                                }
                                else
                                {
                                    <span class="badge bg-success-soft text-success rounded-pill">Clear</span>
                                }
                            </td>
                            <td class="text-end pe-4">
                                <i class="bi bi-chevron-down text-muted"></i>
                            </td>
                        </tr>

                        <tr>
                            <td colspan="6" class="p-0 border-0">
                                <div class="collapse" id="@collapseId">
                                    <div class="p-4 bg-light border-bottom">
                                        <h6 class="fw-bold mb-3"><i class="bi bi-journal-text me-2"></i>Current Books with @m.Name</h6>

                                        @if (memberActiveLoans.Any())
                                        {
                                            <div class="table-responsive rounded-3 shadow-sm bg-white">
                                                <table class="table table-sm mb-0">
                                                    <thead class="table-light small">
                                                        <tr>
                                                            <th class="ps-3">Book Title</th>
                                                            <th>Due Date</th>
                                                            <th>Fine</th>
                                                            <th class="text-end pe-3">Action</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @foreach (var loan in memberActiveLoans)
                                                        {
                                                            var loanOverdue = loan.DueDate < DateTime.Now;
                                                            <tr>
                                                                <td class="ps-3">
                                                                    <span class="fw-medium">@loan.Book.Title</span><br />
                                                                    <small class="text-muted">ISBN: @loan.Book.ISBN</small>
                                                                </td>
                                                                <td class="@(loanOverdue ? "text-danger fw-bold" : "")">
                                                                    @loan.DueDate.ToString("MMM dd, yyyy")
                                                                </td>
                                                                <td>
                                                                    @if (loan.CalculateLateFee > 0)
                                                                    {
                                                                        <span class="text-danger">₹@loan.CalculateLateFee</span>
                                                                    }
                                                                    else
                                                                    {
                                                                        <span class="text-muted">--</span>
                                                                    }
                                                                </td>
                                                                <td class="text-end pe-3">
                                                                    <form asp-action="Return" method="post" class="d-inline">
                                                                        <input type="hidden" name="loanId" value="@loan.Id" />
                                                                        <button type="submit" class="btn btn-sm btn-outline-primary rounded-pill">Mark Returned</button>
                                                                    </form>
                                                                </td>
                                                            </tr>
                                                        }
                                                    </tbody>
                                                </table>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="text-center py-3 text-muted small border rounded bg-white">
                                                No active books currently borrowed.
                                            </div>
                                        }
                                    </div>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    .avatar-circle {
        width: 35px;
        height: 35px;
        background: #6366f1;
        color: white;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.9rem;
    }

    .stats-icon {
        width: 45px;
        height: 45px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
    }

    .bg-primary-soft {
        background-color: #eef2ff;
        color: #4f46e5;
    }

    .bg-danger-soft {
        background-color: #fef2f2;
        color: #dc2626;
    }

    .bg-success-soft {
        background-color: #f0fdf4;
        color: #16a34a;
    }

    .bg-warning-soft {
        background-color: #fffbeb;
        color: #d97706;
    }

    .member-row:hover {
        background-color: #f8fafc !important;
    }

    .animate-fade-in {
        animation: fadeIn 0.5s ease-in-out;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<script>
    document.getElementById('loanSearch').addEventListener('keyup', function() {
        let val = this.value.toLowerCase();
        let rows = document.querySelectorAll('#loansTable tbody .member-row');
        rows.forEach(row => {
            let text = row.innerText.toLowerCase();
            row.style.display = text.includes(val) ? '' : 'none';
            // Hide the associated collapse row if the main row is hidden
            let nextRow = row.nextElementSibling;
            if (nextRow && nextRow.querySelector('.collapse')) {
                nextRow.style.display = text.includes(val) ? '' : 'none';
            }
        });
    });
</script>